name: Build EXE

on:
  workflow_dispatch:
    inputs:
      url:
        description: '目标网址'
        required: true
      app_name:
        description: '应用名称（支持中文）'
        required: true
      version:
        description: '版本号'
        required: true
        default: '1.0.0'
      icon_url:
        description: '图标 URL（可为空）'
        required: false
        default: ''
      task_id:
        description: '任务 ID'
        required: true

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Init project
        shell: pwsh
        run: |
          npm init -y
          npm install electron electron-builder --save-dev

      - name: Generate main.js
        shell: pwsh
        run: |
          $targetUrl = '${{ inputs.url }}'
          $main = @"
          const { app, BrowserWindow } = require('electron')
          app.whenReady().then(() => {
            const win = new BrowserWindow({
              width: 1280,
              height: 800,
              webPreferences: { nodeIntegration: false }
            })
            win.loadURL('$targetUrl')
          })
          "@
          Set-Content -Path main.js -Value $main -Encoding UTF8

      - name: Download custom icon
        if: ${{ inputs.icon_url != '' }}
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path build | Out-Null
          $url = '${{ inputs.icon_url }}'

          # 下载到临时文件
          $tmpFile = 'build/icon_tmp'
          Invoke-WebRequest -Uri $url -OutFile $tmpFile

          # 读取 magic bytes 判断真实格式，不依赖 URL 后缀
          $bytes = [System.IO.File]::ReadAllBytes($tmpFile)

          if ($bytes[0] -eq 0x89 -and $bytes[1] -eq 0x50 -and $bytes[2] -eq 0x4E -and $bytes[3] -eq 0x47) {
            Write-Host "检测到 PNG 格式"
            Move-Item -Force $tmpFile 'build/icon.png'
          } elseif ($bytes[0] -eq 0x00 -and $bytes[1] -eq 0x00 -and $bytes[2] -eq 0x01 -and $bytes[3] -eq 0x00) {
            Write-Host "检测到 ICO 格式"
            Move-Item -Force $tmpFile 'build/icon.ico'
          } else {
            Write-Host "未知格式，按 PNG 处理"
            Move-Item -Force $tmpFile 'build/icon.png'
          }

          Get-ChildItem build

      - name: Generate package.json
        shell: pwsh
        run: |
          $productName = '${{ inputs.app_name }}'
          $version     = '${{ inputs.version }}'

          $safeName = $productName -replace '[^a-zA-Z0-9\-]', '-'
          $safeName = $safeName.ToLower().Trim('-')
          if ([string]::IsNullOrWhiteSpace($safeName) -or $safeName -eq '-') {
            $safeName = 'myapp'
          }
          $safeName = $safeName -replace '-{2,}', '-'
          $safeName = $safeName.Trim('-')

          Write-Host "productName : $productName"
          Write-Host "safeName    : $safeName"
          Write-Host "version     : $version"

          $config = [ordered]@{
            name    = $safeName
            version = $version
            main    = "main.js"
            build   = [ordered]@{
              appId       = "com.webtoexe.$safeName"
              productName = $productName
              win         = [ordered]@{
                target         = "portable"
                executableName = $safeName
              }
            }
            scripts = @{ dist = "electron-builder --win" }
          }
          $config | ConvertTo-Json -Depth 10 | Set-Content -Path package.json -Encoding UTF8
          Get-Content package.json

      - name: Build EXE
        shell: pwsh
        env:
          GH_TOKEN: ''
        run: |
          npx electron-builder --win --x64 --publish never

      - name: Upload EXE as artifact
        uses: actions/upload-artifact@v4
        with:
          name: exe-${{ inputs.task_id }}
          path: dist/*.exe
          if-no-files-found: error

      - name: Print artifact info
        shell: pwsh
        run: |
          Write-Host "task_id : ${{ inputs.task_id }}"
          Write-Host "run_id  : ${{ github.run_id }}"
          Get-ChildItem dist
