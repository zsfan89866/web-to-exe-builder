name: Build EXE

on:
  workflow_dispatch:
    inputs:
      url:
        description: '目标网址'
        required: true
      app_name:
        description: '应用名称（支持中文）'
        required: true
      version:
        description: '版本号'
        required: true
        default: '1.0.0'
      icon_url:
        description: '图标 URL（可为空）'
        required: false
        default: ''
      task_id:
        description: '任务 ID'
        required: true

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Init project
        shell: pwsh
        run: |
          npm init -y
          npm install electron electron-builder --save-dev

      - name: Generate main.js
        shell: pwsh
        run: |
          $targetUrl = '${{ inputs.url }}'
          $main = @"
          const { app, BrowserWindow, Menu } = require('electron')

          app.whenReady().then(() => {
            Menu.setApplicationMenu(null)

            const win = new BrowserWindow({
              width: 1280,
              height: 800,
              webPreferences: {
                nodeIntegration: false,
                contextIsolation: true,
              }
            })

            win.webContents.on('did-start-loading', () => {
              win.webContents.executeJavaScript(\`
                (function() {
                  if (document.getElementById('__pb__')) return

                  const wrap = document.createElement('div')
                  wrap.id = '__pb__'
                  wrap.style.cssText = [
                    'position:fixed','top:0','left:0',
                    'width:100%','height:4px',
                    'z-index:2147483647',
                    'pointer-events:none',
                    'background:transparent',
                  ].join(';')

                  const bar = document.createElement('div')
                  bar.id = '__pb_bar__'
                  bar.style.cssText = [
                    'height:4px',
                    'width:0%',
                    'border-radius:0 4px 4px 0',
                    'background:#3B82F6',
                    'box-shadow:0 0 10px rgba(59,130,246,0.6)',
                    'transition:width 0.3s cubic-bezier(0.4,0,0.2,1),background 0.8s ease,box-shadow 0.8s ease',
                  ].join(';')

                  wrap.appendChild(bar)
                  document.documentElement.appendChild(wrap)

                  let progress = 0
                  window.__pbTimer__ = setInterval(() => {
                    if (progress < 85) {
                      const step = progress < 30 ? 6 : progress < 60 ? 3 : 0.8
                      progress += Math.random() * step
                      progress = Math.min(progress, 85)
                      bar.style.width = progress + '%'

                      const blue  = [59, 130, 246]
                      const green = [34, 197, 94]
                      const t = Math.min(progress / 85, 1)
                      const r = Math.round(blue[0] + (green[0]-blue[0]) * t)
                      const g = Math.round(blue[1] + (green[1]-blue[1]) * t)
                      const b = Math.round(blue[2] + (green[2]-blue[2]) * t)
                      const color = 'rgb('+r+','+g+','+b+')'
                      bar.style.background = color
                      bar.style.boxShadow  = '0 0 10px rgba('+r+','+g+','+b+',0.65)'
                    }
                  }, 180)
                })()
              \`).catch(() => {})
            })

            win.webContents.on('did-finish-load', () => {
              win.webContents.executeJavaScript(\`
                (function() {
                  const bar = document.getElementById('__pb_bar__')
                  if (!bar) return
                  clearInterval(window.__pbTimer__)
                  bar.style.transition = 'width 0.25s ease,background 0.3s ease,box-shadow 0.3s ease,opacity 0.4s ease 0.35s'
                  bar.style.width      = '100%'
                  bar.style.background = '#22C55E'
                  bar.style.boxShadow  = '0 0 12px rgba(34,197,94,0.7)'
                  setTimeout(() => {
                    bar.style.opacity = '0'
                    setTimeout(() => {
                      const wrap = document.getElementById('__pb__')
                      if (wrap) wrap.remove()
                    }, 450)
                  }, 350)
                })()
              \`).catch(() => {})
            })

            win.webContents.on('did-fail-load', () => {
              win.webContents.executeJavaScript(\`
                (function() {
                  const bar = document.getElementById('__pb_bar__')
                  if (!bar) return
                  clearInterval(window.__pbTimer__)
                  bar.style.transition = 'width 0.2s ease,background 0.2s ease,opacity 0.4s ease 0.8s'
                  bar.style.width      = '100%'
                  bar.style.background = '#EF4444'
                  bar.style.boxShadow  = '0 0 10px rgba(239,68,68,0.7)'
                  setTimeout(() => {
                    bar.style.opacity = '0'
                    setTimeout(() => {
                      const wrap = document.getElementById('__pb__')
                      if (wrap) wrap.remove()
                    }, 450)
                  }, 900)
                })()
              \`).catch(() => {})
            })

            win.loadURL('$targetUrl')
          })

          app.on('window-all-closed', () => app.quit())
          "@
          Set-Content -Path main.js -Value $main -Encoding UTF8

      - name: Download custom icon
        if: ${{ inputs.icon_url != '' }}
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path build | Out-Null
          $url = '${{ inputs.icon_url }}'
          $tmpFile = 'build/icon_tmp'
          Invoke-WebRequest -Uri $url -OutFile $tmpFile

          $bytes = [System.IO.File]::ReadAllBytes($tmpFile)
          if ($bytes[0] -eq 0x89 -and $bytes[1] -eq 0x50 -and $bytes[2] -eq 0x4E -and $bytes[3] -eq 0x47) {
            Write-Host "检测到 PNG 格式"
            Move-Item -Force $tmpFile 'build/icon.png'
          } elseif ($bytes[0] -eq 0x00 -and $bytes[1] -eq 0x00 -and $bytes[2] -eq 0x01 -and $bytes[3] -eq 0x00) {
            Write-Host "检测到 ICO 格式"
            Move-Item -Force $tmpFile 'build/icon.ico'
          } else {
            Write-Host "未知格式，按 PNG 处理"
            Move-Item -Force $tmpFile 'build/icon.png'
          }
          Get-ChildItem build

      - name: Generate package.json
        shell: pwsh
        run: |
          $productName = '${{ inputs.app_name }}'
          $rawVersion  = '${{ inputs.version }}'

          # 去掉开头的 v/V
          $rawVersion = $rawVersion -replace '^[vV]+', ''
          # 只保留数字和点
          $rawVersion = $rawVersion -replace '[^0-9.]', ''
          # 去掉首尾的点
          $rawVersion = $rawVersion.Trim('.')
          # 用 [char]'.' 分割，避免转义问题
          $parts = $rawVersion.Split([char]'.') | Where-Object { $_ -ne '' }
          # 补全到三段
          while ($parts.Count -lt 3) { $parts += @('0') }
          $version = $parts[0] + '.' + $parts[1] + '.' + $parts[2]

          Write-Host "原始版本号: $rawVersion"
          Write-Host "修正版本号: $version"

          $safeName = $productName -replace '[^a-zA-Z0-9\-]', '-'
          $safeName = $safeName.ToLower().Trim('-')
          if ([string]::IsNullOrWhiteSpace($safeName) -or $safeName -match '^-+$') {
            $safeName = 'myapp'
          }
          $safeName = $safeName -replace '-{2,}', '-'
          $safeName = $safeName.Trim('-')

          Write-Host "productName: $productName"
          Write-Host "safeName   : $safeName"

          $json = @"
          {
            "name": "$safeName",
            "version": "$version",
            "main": "main.js",
            "build": {
              "appId": "com.webtoexe.$safeName",
              "productName": "$productName",
              "win": {
                "target": "portable",
                "executableName": "$safeName"
              }
            },
            "scripts": {
              "dist": "electron-builder --win"
            }
          }
          "@
          Set-Content -Path package.json -Value $json -Encoding UTF8
          Get-Content package.json

      - name: Build EXE
        shell: pwsh
        env:
          GH_TOKEN: ''
        run: |
          npx electron-builder --win --x64 --publish never

      - name: Upload EXE as artifact
        uses: actions/upload-artifact@v4
        with:
          name: exe-${{ inputs.task_id }}
          path: dist/*.exe
          if-no-files-found: error

      - name: Print artifact info
        shell: pwsh
        run: |
          Write-Host "task_id : ${{ inputs.task_id }}"
          Write-Host "run_id  : ${{ github.run_id }}"
          Get-ChildItem dist
